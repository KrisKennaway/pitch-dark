;license:MIT
;(c) 2018 by 4am
;
; Global and per-game preferences
;
; Public functions
; - LoadGlobalPreferences
; - SaveGlobalPreferences
;
; Public variables
; - gCurrentGame          byte       0..kNumberOfGames-1
;
; Public constants
; - kForce40
; - kForceUpper
; - kSort
; - kLastPlayed

!zone {
kDefaultGame              = 30       ; Zork I

gCurrentGame
         !byte 0

kForce40
         !byte 14
         !raw  "FORCE40COLUMNS"
kForceUpper
         !byte 14
         !raw  "FORCEUPPERCASE"
kScriptToFile
         !byte 12
         !raw  "SCRIPTTOFILE"
kAutoScript
         !byte 10
         !raw  "AUTOSCRIPT"
kLastPlayed
         !byte 10
         !raw  "LASTPLAYED"

;------------------------------------------------------------------------------
; LoadGlobalPreferences
;
; in:    current ProDOS prefix is the same as the PITCH.DARK binary
; out:   all registers and flags clobbered
;------------------------------------------------------------------------------
LoadGlobalPreferences
         lda   #kDefaultGame
         sta   gCurrentGame

         jsr   okvs_init
         !word gPrefsStore

         lda   gCurrentGame
         asl
         tax
         lda   GAMES,x
         sta   .gameptr
         lda   GAMES+1,x
         sta   .gameptr+1
         jsr   okvs_append
         !word gPrefsStore
         !word kLastPlayed
.gameptr !word $FDFD                 ; set at runtime
         !byte 16

         jsr   okvs_append
         !word gPrefsStore
         !word kForce40
         !word .debug0
         !byte 0

         jsr   okvs_append
         !word gPrefsStore
         !word kForceUpper
         !word .debug0
         !byte 0

         jsr   okvs_append
         !word gPrefsStore
         !word kScriptToFile
         !word .debug1
         !byte 0

         jsr   okvs_append
         !word gPrefsStore
         !word kAutoScript
         !word .debug0
         !byte 0

         bra   .exit
         ; TODO
         jsr   LoadFile              ; load prefs file at $2000
         !word .globalPrefsFilename
         !word $2000
         !word $2000
         !word kProDOSFileBuffer
         bcs   .exit
.exit
         rts

SaveGlobalPreferences
         ; TODO
         rts

.globalPrefsFilename
         !byte 15
         !raw  "PITCH.DARK.CONF"

.debug0
         !byte 1
         !byte 0
.debug1
         !byte 1
         !byte 1
}
